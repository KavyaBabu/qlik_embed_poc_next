import { Page } from "@arqiva/react-component-lib";
import logger from "@/lib/services/logger";
import QueryParamsUrlProvider from "@/app/_components/QueryParamsUrlProvider";
import DashboardInner, { DashboardFilters } from "./Inner";
import LeakageListPage from "./widgets/leakageList/page";
import { useState } from "react";

const DashboardPage = () => {
  const [dashboardFilters, setDashboardFilters] = useState<DashboardFilters>({});

  return (
    <Page.Root>
      <Page.Head>
        <Page.Title>Dashboard</Page.Title>
      </Page.Head>

      {/* Dashboard gets its own QueryParams root */}
      <QueryParamsUrlProvider initialParams={{}}>
        <DashboardInner onFiltersChange={setDashboardFilters} />
      </QueryParamsUrlProvider>

      {/* LeakageList has a SEPARATE QueryParams root */}
      <LeakageListPage dashboardFilters={dashboardFilters} />
    </Page.Root>
  );
};

export default DashboardPage;


"use client";

import { useEffect } from "react";
import { QueryParams, useQueryParams } from "@arqiva/react-component-lib";
import {
  GroupFilter, groupFilterOverride,
  DateRangeFilter, dateRangeFilterOverride,
  TimeFilter, timeFilterOverride,
  ConsumptionFilter, consumptionFilterOverride
} from "@/lib/services/api/dashboard/Kpis/filters";
import MeterConsumptionPage from "./widgets/meterConsumption/page";
import LeakagePage from "./widgets/leakgaeInfo/page";
import Top10MeterPage from "./widgets/top10Meters/page";
import FlowValuesInner from "./widgets/flowValues/Inner";
import styles from "./index.module.css";

export interface DashboardFilters {
  group_id?: string;
  dateRange?: string;
  timeRange?: string;
  consumption_range?: string;
}

interface DashboardInnerProps {
  onFiltersChange: (filters: DashboardFilters) => void;
}

export const DashboardInner = ({ onFiltersChange }: DashboardInnerProps) => {
  const { queryParams } = useQueryParams();

  useEffect(() => {
    onFiltersChange({
      group_id: queryParams.group_id,
      dateRange: queryParams.dateRange,
      timeRange: queryParams.timeRange,
      consumption_range: queryParams.consumption_range,
    });
  }, [
    queryParams.group_id,
    queryParams.dateRange,
    queryParams.timeRange,
    queryParams.consumption_range,
    onFiltersChange,
  ]);

  return (
    <QueryParams.Params.Root>
      <QueryParams.Params.Filters>
        <GroupFilter />
        <DateRangeFilter />
        <TimeFilter />
        <ConsumptionFilter />
      </QueryParams.Params.Filters>

      <QueryParams.Params.SelectedValues
        resultsLoading={false}
        resultsCount={0}
        filterOverrides={{
          ...groupFilterOverride,
          ...dateRangeFilterOverride,
          ...timeFilterOverride,
          ...consumptionFilterOverride,
        }}
        filterIgnoreList={["q"]}
      />

      <section className={styles.dashboard}>
        <div className={styles["dashboard--full-width"]}>
          <h2>Meter Consumption</h2>
          <MeterConsumptionPage />
        </div>

        <div className={styles["dashboard--full-width"]}>
          <h2>Leakage</h2>
          <LeakagePage />
        </div>

        <div className={styles["dashboard__split-row"]}>
          <div className={styles["dashboard__main-column"]}>
            <h2>Top 10 Meters</h2>
            <Top10MeterPage />
          </div>

          <div className={styles["dashboard__side-column"]}>
            <h2>Flow Values</h2>
            <FlowValuesInner />
          </div>
        </div>
      </section>
    </QueryParams.Params.Root>
  );
};

export default DashboardInner;

"use client";

import LeakageListInner from "./Inner";
import { DashboardFilters } from "@/app/dashboard/Inner";

interface Props {
  dashboardFilters: DashboardFilters;
}

export default function LeakageListPage({ dashboardFilters }: Props) {
  return <LeakageListInner dashboardFilters={dashboardFilters} />;
}

"use client";

import { useMemo } from "react";
import { QueryParams, useQueryParams } from "@arqiva/react-component-lib";
import SearchQueryFilter, {
  searchQueryFilterOverride,
} from "@/lib/services/common/SearchQueryFilter";
import { LeakageList } from "@/lib/services/api/dashboard/Kpis/components/Leakage/List";
import {
  mapKpiQueryParams,
  buildLeakageApiRequest,
} from "@/lib/services/api/dashboard/Kpis/utils/queryParamMapper";
import { LeakageListRequest } from "@/lib/services/api/dashboard/Kpis/models/getLeakageList";
import { DashboardFilters } from "@/app/dashboard/Inner";

interface LeakageProps {
  dashboardFilters: DashboardFilters;
}

export default function LeakageListInner({ dashboardFilters }: LeakageProps) {
  const filtersKey = JSON.stringify(dashboardFilters);

  return (
    <QueryParams.Params.Root initialParams={dashboardFilters} key={filtersKey}>
      <LeakageListScoped />
    </QueryParams.Params.Root>
  );
}

function LeakageListScoped() {
  const { queryParams } = useQueryParams<LeakageListRequest>();

  const queryParameters = useMemo(() => {
    const mapped = mapKpiQueryParams(queryParams, "leakage");
    return buildLeakageApiRequest(mapped);
  }, [queryParams]);

  return (
    <LeakageList queryParameters={queryParameters}>
      {({ resultsLoading, resultsCount }) => (
        <>
          <SearchQueryFilter placeholder="Search" />

          <QueryParams.Params.SelectedValues
            resultsLoading={resultsLoading}
            resultsCount={resultsCount}
            filterOverrides={searchQueryFilterOverride}
            filterIgnoreList={[
              "group_id",
              "dateRange",
              "timeRange",
              "consumption_range",
            ]}
          />
        </>
      )}
    </LeakageList>
  );
}


Type 'DashboardFilters' is not assignable to type 'QueryParamsRecord'.
  Index signature for type 'string' is missing in type 'DashboardFilters'.ts(2322)
index.d.ts(12, 5): The expected type comes from property 'initialParams' which is declared here on type 'IntrinsicAttributes & QueryParamsRootProps<QueryParamsRecord>'
(property) QueryParamsRootProps<QueryParamsRecord>.initialParams?: QueryParamsRecord | undefined
