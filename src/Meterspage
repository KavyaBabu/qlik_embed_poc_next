"use client";

import { useEffect, useRef, useMemo } from "react";
import { QueryParams, useQueryParams } from "@arqiva/react-component-lib";
import {
  DateRangeFilter,
  dateRangeFilterOverride,
} from "@/lib/services/api/dashboard/Kpis/filters/DateRangeFilter";
import {
  MetersFilter,
  meterFilterOverride,
} from "@/lib/services/api/dashboard/Kpis/filters/MetersFilter";
import { useCustomerContext } from "@/app/_components/CustomerProvider";
import KpiSummary from "./widgets/KpiSummary/page";
import MedianVsWeek from "./widgets/MedianVsWeek/page";
import LeakageHistory from "./widgets/LeakageHistory/page";
import DailyUsage from "./widgets/DailyUsage/page";
import ConsumptionTrend from "./widgets/ConsumptionTrend/page";
import styles from "./index.module.css";

const DASHBOARD_FILTERS_KEY = "dashboard-filters";
const METERS_FILTERS_KEY = "meters-filters";

/* -------------------- storage helpers -------------------- */

const saveFiltersToStorage = (filters: MetersFilters) => {
  try {
    localStorage.setItem(METERS_FILTERS_KEY, JSON.stringify(filters));
  } catch {}
};

const loadFiltersFromStorage = (): MetersFilters | null => {
  try {
    const stored = localStorage.getItem(METERS_FILTERS_KEY);
    return stored ? JSON.parse(stored) : null;
  } catch {
    return null;
  }
};

const loadDashboardFiltersFromStorage = (): DashboardFilters | null => {
  try {
    const stored = localStorage.getItem(DASHBOARD_FILTERS_KEY);
    return stored ? JSON.parse(stored) : null;
  } catch {
    return null;
  }
};

/* -------------------- types -------------------- */

interface DashboardFilters {
  group_id?: string;
  dateRange?: string;
}

export interface MetersFilters {
  meter_id?: string;
  dateRange?: string;
}

interface FiltersBarProps {
  onFiltersChange: (filters: MetersFilters) => void;
}

/* -------------------- FiltersBar -------------------- */

const FiltersBar = ({ onFiltersChange }: FiltersBarProps) => {
  const { queryParams, setParam, clearAllParams } = useQueryParams();
  const { effectiveCustomerId } = useCustomerContext();

  const previousFiltersRef = useRef<MetersFilters>({});
  const hasRestoredRef = useRef(false);
  const userModifiedDateRangeRef = useRef(false);
  const previousCustomerIdRef = useRef<string>(effectiveCustomerId);
  const isClearingRef = useRef(false);

  /* ---------- customer change reset ---------- */

  useEffect(() => {
    if (previousCustomerIdRef.current !== effectiveCustomerId) {
      previousCustomerIdRef.current = effectiveCustomerId;
      isClearingRef.current = true;

      clearAllParams();
      localStorage.removeItem(METERS_FILTERS_KEY);

      hasRestoredRef.current = false;
      previousFiltersRef.current = {};
      userModifiedDateRangeRef.current = false;

      setTimeout(() => {
        isClearingRef.current = false;
      }, 0);
    }
  }, [effectiveCustomerId, clearAllParams]);

  /* ---------- page type ---------- */

  const isGeneralMetersPage = useMemo(() => {
    const path = window.location.pathname;
    return path.endsWith("/meters") && !path.match(/\/meters\/[^/]+$/);
  }, []);

  /* ---------- infer meter_id from /meters/:id ---------- */

  useEffect(() => {
    if (isClearingRef.current) return;

    const match = window.location.pathname.match(/\/meters\/([^/]+)$/);
    if (match && !queryParams.meter_id) {
      setParam("meter_id", match[1]);
    }
  }, [queryParams.meter_id, setParam]);

  /* ---------- dashboard â†’ meters date inheritance ---------- */

  useEffect(() => {
    if (isClearingRef.current) return;
    if (isGeneralMetersPage) return;

    const dashboardFilters = loadDashboardFiltersFromStorage();
    const dashboardDateRange = dashboardFilters?.dateRange;

    if (
      !userModifiedDateRangeRef.current &&
      dashboardDateRange &&
      queryParams.dateRange !== dashboardDateRange
    ) {
      setParam("dateRange", dashboardDateRange);
    }
  }, [queryParams.dateRange, isGeneralMetersPage, setParam]);

  /* ---------- restore from storage (first load only) ---------- */

  useEffect(() => {
    if (isClearingRef.current) return;
    if (hasRestoredRef.current) return;

    const hasParams = Object.values(queryParams).some(Boolean);
    if (hasParams) {
      hasRestoredRef.current = true;
      return;
    }

    const storedMeters = loadFiltersFromStorage();
    const storedDashboard = loadDashboardFiltersFromStorage();

    if (storedDashboard?.dateRange) {
      setParam("dateRange", storedDashboard.dateRange);
    }

    if (storedMeters?.meter_id) {
      setParam("meter_id", storedMeters.meter_id);
    }

    hasRestoredRef.current = true;
  }, [queryParams, setParam]);

  /* ---------- sync filters ---------- */

  useEffect(() => {
    if (isClearingRef.current) return;

    const current: MetersFilters = {
      meter_id: queryParams.meter_id
        ? String(queryParams.meter_id)
        : undefined,
      dateRange: queryParams.dateRange
        ? String(queryParams.dateRange)
        : undefined,
    };

    const changed =
      current.meter_id !== previousFiltersRef.current.meter_id ||
      current.dateRange !== previousFiltersRef.current.dateRange;

    if (!changed) return;

    const dashboardFilters = loadDashboardFiltersFromStorage();

    userModifiedDateRangeRef.current =
      !!current.dateRange &&
      current.dateRange !== dashboardFilters?.dateRange;

    previousFiltersRef.current = current;

    saveFiltersToStorage({
      meter_id: current.meter_id,
    });

    onFiltersChange(current);
  }, [queryParams.meter_id, queryParams.dateRange, onFiltersChange]);

  /* ---------- Clear All (FIX) ---------- */

  const handleClearAll = () => {
    isClearingRef.current = true;

    clearAllParams();
    localStorage.removeItem(METERS_FILTERS_KEY);

    hasRestoredRef.current = true;
    previousFiltersRef.current = {};
    userModifiedDateRangeRef.current = false;

    onFiltersChange({});

    setTimeout(() => {
      isClearingRef.current = false;
    }, 0);
  };

  /* ---------- render ---------- */

  return (
    <div className={styles.meters__filters}>
      <QueryParams.Params.Filters>
        <MetersFilter />
        <DateRangeFilter />
      </QueryParams.Params.Filters>

      <QueryParams.Params.SelectedValues
        resultsLoading={false}
        onClearAll={handleClearAll}
        filterOverrides={{
          ...meterFilterOverride,
          ...dateRangeFilterOverride,
        }}
        filterIgnoreList={["q", "page", "perPage", "sortBy", "sortDir"]}
      />
    </div>
  );
};

/* -------------------- Content -------------------- */

const Content = ({ metersFilters }: { metersFilters: MetersFilters }) => (
  <section className={styles.meters}>
    <div className={styles["meters--full-width"]}>
      <KpiSummary meterId={metersFilters.meter_id} />
    </div>

    <div className={styles["meters__split-row"]}>
      <div className={styles["meters__main-column"]}>
        <h3 className={styles["meters__section-heading"]}>
          Consumption Trend
        </h3>
        <ConsumptionTrend meterId={metersFilters.meter_id} />
      </div>
      <div className={styles["meters__side-column"]}>
        <h3 className={styles["meters__section-heading"]}>
          Median vs this weeks consumption
        </h3>
        <MedianVsWeek meterId={metersFilters.meter_id} />
      </div>
    </div>

    <div className={styles["meters__split-row"]}>
      <div className={styles["meters__main-column"]}>
        <h3 className={styles["meters__section-heading"]}>
          Leakage History
        </h3>
        <LeakageHistory meterId={metersFilters.meter_id} threshold={0.5} />
      </div>
      <div className={styles["meters__side-column"]}>
        <h3 className={styles["meters__section-heading"]}>
          Daily Usage
        </h3>
        <DailyUsage meterId={metersFilters.meter_id} />
      </div>
    </div>
  </section>
);

const MetersInner = { FiltersBar, Content };
export default MetersInner;
