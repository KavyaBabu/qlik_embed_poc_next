"use client";

import {
  handleSingleSearchableSelectChange,
  SearchableSelect,
  useQueryParams,
} from "@arqiva/react-component-lib";
import { memo, useMemo } from "react";
import { useListAllMeters } from "@/lib/services/api/dashboard/Meters/hooks/useListMeters";
import { useCustomerContext } from "@/app/_components/CustomerProvider";

export const MetersFilter = memo(() => {
  const { queryParams, setParam } = useQueryParams();
  const { effectiveCustomerId } = useCustomerContext();

  const { data, isLoading } = useListAllMeters({
    queryParameters: { customer_id: effectiveCustomerId },
  });

  const options = useMemo(() => {
    const items = data?.items ?? [];
    return items.map((m) => ({
      value: String(m.id),
      label: String(m.id),
    }));
  }, [data]);

  // ✅ Normalize meter_id coming from query params (string/number/array-safe)
  const selectedMeterId = useMemo(() => {
    const v: any = queryParams?.meter_id;
    if (Array.isArray(v)) return v[0] ? String(v[0]) : undefined;
    if (v === undefined || v === null || v === "") return undefined;
    return String(v);
  }, [queryParams?.meter_id]);

  const selectedOption = useMemo(() => {
    if (!selectedMeterId) return null;
    return options.find((o) => o.value === selectedMeterId) ?? null;
  }, [options, selectedMeterId]);

  const menuPortalTarget =
    typeof window === "undefined" ? undefined : document.body;

  if (!queryParams || !setParam) return null;

  return (
    <SearchableSelect
      clearable
      options={options}
      isLoading={isLoading}
      value={selectedOption}
      onChange={handleSingleSearchableSelectChange((value) => {
        // ✅ Always drive URL from selection
        setParam("meter_id", value ? String(value) : undefined);
      })}
      placeholder="Meter"
      menuPortalTarget={menuPortalTarget}
      menuPosition="fixed"
      styles={{
        menuPortal: (base) => ({ ...base, zIndex: 2000 }),
        menu: (base) => ({ ...base, zIndex: 2000 }),
      }}
    />
  );
});

MetersFilter.displayName = "MetersFilter";

export const meterFilterOverride = {
  meter_id: {
    label: "Meter",
    valueTransform: String,
  },
};
